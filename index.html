<!DOCTYPE html>
<html>
  <head>
    <link
      href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css"
      rel="stylesheet"
    />
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui"
    />
  </head>
  <body>
    <div id="app">
      <v-app>
        <v-app-bar app color="primary" class="white--text font-weight-bold">
          <v-app-bar-nav-icon color="white"></v-app-bar-nav-icon>
          <v-spacer></v-spacer>

          <v-toolbar-title> Bollywood Silver Screen</v-toolbar-title>

          <v-spacer></v-spacer>
          <v-app-bar-nav-icon color="white" @click="openSearch()">
            <v-icon>mdi-magnify</v-icon>
          </v-app-bar-nav-icon>
        </v-app-bar>

        <v-main>
          <v-container>
            <template v-for="(genre, index) in genres">
              <template v-if="genre.movies.length">
                <v-card-title>
                  {{genre.name}}
                  <v-spacer></v-spacer>
                  <v-icon @click="openGenre(genre)">mdi-chevron-right</v-icon>
                </v-card-title>

                <v-slide-group>
                  <v-slide-item class="ml-2" v-for="(movie, index) in genre.movies" :key="index">
                    <v-card @click="onClick(movie, genre)" width="100">
                      <v-img :src="`https://image.tmdb.org/t/p/w500${movie.poster_path}`"></v-img>
                    </v-card>
                  </v-slide-item>
                </v-slide-group>
              </template>
            </template>

            <v-dialog v-model="dialog.search" fullscreen>
              <v-card>
                <v-card-title>
                  <v-text-field
                    prepend-inner-icon="mdi-arrow-left"
                    solo
                    v-model="search"
                    label="Search"
                    @click:prepend-inner="dialog.search = false"
                  ></v-text-field>
                </v-card-title>

                <v-list v-if="!search">
                  <v-subheader>Popular</v-subheader>
                  <v-list-item
                    @click="onClick(item, genre)"
                    v-for="(item, index) in popularMovies"
                    :key="index"
                  >
                    <v-list-item-avatar rounded>
                      <v-img :src="`https://image.tmdb.org/t/p/w500${item.poster_path}`"></v-img>
                    </v-list-item-avatar>
                    <v-list-item-content>
                      <v-list-item-title>{{item.title}}</v-list-item-title>
                    </v-list-item-content>
                  </v-list-item>
                </v-list>

                <v-list v-else>
                  <v-list-item
                    @click="onClick(item, genre)"
                    v-for="(item, index) in getFilteredMovies()"
                    :key="index"
                  >
                    <v-list-item-avatar rounded>
                      <v-img :src="`https://image.tmdb.org/t/p/w500${item.poster_path}`"></v-img>
                    </v-list-item-avatar>
                    <v-list-item-content>
                      <v-list-item-title>{{item.title}}</v-list-item-title>
                    </v-list-item-content>
                  </v-list-item>
                </v-list>
              </v-card>
            </v-dialog>

            <v-dialog v-model="dialog.genre" fullscreen>
              <v-card>
                <v-card-title>
                  <v-icon @click="dialog.genre=false">mdi-arrow-left</v-icon>
                  <v-spacer></v-spacer>
                  {{genre.name}}
                  <v-spacer></v-spacer>
                  <v-icon @click="openSearch()">mdi-magnify</v-icon>
                </v-card-title>

                <v-card-text>
                  <v-row>
                    <template v-for="(item, index) in genre.movies">
                      <v-col cols="4" :key="index">
                        <v-card @click="onClick(item, genre)">
                          <v-img
                            :src="`https://image.tmdb.org/t/p/w500${item.poster_path}`"
                          ></v-img>
                        </v-card>
                      </v-col>
                    </template>
                  </v-row>
                </v-card-text>
              </v-card>
            </v-dialog>

            <v-dialog v-model="dialog.view" fullscreen>
              <v-card>
                <v-card-title>
                  <v-icon @click="dialog.view=false">mdi-arrow-left</v-icon>
                  <v-spacer></v-spacer>
                  {{movie.title}}
                  <v-spacer></v-spacer>
                  <v-icon @click="openSearch()">mdi-magnify</v-icon>
                </v-card-title>

                <v-responsive aspect-ratio="1.77">
                  <iframe
                    width="100%"
                    height="100%"
                    :src="`https://www.youtube-nocookie.com/embed/${getComment(movie)}`"
                    title="YouTube video player"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen
                  ></iframe>
                </v-responsive>

                <v-card-title class="mb-4"> {{movie.title}} ({{getYear(movie)}}) </v-card-title>

                <v-card-subtitle>
                  <v-chip
                    dense
                    outlined
                    class="mr-2 mb-2"
                    v-for="(item, index) in getMovieGenres(movie)"
                    >{{item}}</v-chip
                  >
                </v-card-subtitle>

                <v-card-subtitle> {{movie.overview}} </v-card-subtitle>

                <template v-if="collection.name">
                  <v-card-title class="mb-4"> More from {{collection.name}} </v-card-title>
                  <v-card-text>
                    <v-slide-group>
                      <template v-for="(item, index) in collection.parts">
                        <v-slide-item v-if="item.id != movie.id" class="ml-2" :key="index">
                          <v-card :disabled="!hasComment(item)" @click="onClick(item)" width="150">
                            <v-img
                              :src="`https://image.tmdb.org/t/p/w500${item.poster_path}`"
                            ></v-img>
                            <!-- <v-card-subtitle> {{item.title}} </v-card-subtitle> -->
                          </v-card>
                        </v-slide-item>
                      </template>
                    </v-slide-group>
                  </v-card-text>
                </template>

                <v-card-title class="mb-4"> More Like This </v-card-title>
                <v-card-text>
                  <v-slide-group>
                    <template v-for="(item, index) in getGenreMovies()">
                      <v-slide-item v-if="item.id != movie.id" class="ml-2" :key="index">
                        <v-card @click="onClick(item, genre)" width="150">
                          <v-img
                            :src="`https://image.tmdb.org/t/p/w500${item.poster_path}`"
                          ></v-img>
                          <!-- <v-card-subtitle> {{item.title}} </v-card-subtitle> -->
                        </v-card>
                      </v-slide-item>
                    </template>
                  </v-slide-group>
                </v-card-text>
              </v-card>
            </v-dialog>
          </v-container>
        </v-main>
      </v-app>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
    <script>
      new Vue({
        el: '#app',
        vuetify: new Vuetify(),
        data() {
          return {
            dialog: {
              view: false,
              search: false,
              genre: false,
            },
            search: '',
            movie: {},
            movies: [],
            popularMovies: [],
            genres: {},
            genre: {},
            list: {},
            collection: {},
          };
        },
        async mounted() {
          await this.getGenres();
          await this.getMovies();
        },
        methods: {
          getYear(movie = {}) {
            return (movie.release_date || '').substring(0, 4);
          },
          getMovieGenres(movie) {
            return (movie.genre_ids || []).map((genre_id) => this.genres[genre_id].name);
          },
          openSearch() {
            this.dialog.genre = false;
            this.dialog.view = false;
            this.dialog.search = true;
          },
          openGenre(genre) {
            this.genre = genre;
            this.dialog.genre = true;
          },
          getFilteredMovies() {
            if (this.search) {
              return this.movies.filter((movie) => {
                return (movie.title || '')
                  .toLowerCase()
                  .includes((this.search || '').trim().toLowerCase());
              });
            } else {
              return [];
            }
          },
          getGenreMovies() {
            return (this.genre.movies || []).filter((movie) => {
              return !(this.collection.parts || []).some((part) => part.id == movie.id);
            });
          },
          hasComment(movie) {
            return !!this.list.comments[`movie:${movie.id}`];
          },
          getComment(movie) {
            return (this.list.comments[`movie:${movie.id}`] || '')
              .replace('https://www.youtube.com/watch?v=', '')
              .replace('https://youtu.be/', '');
          },
          onClick(movie, genre) {
            this.dialog.genre = false;
            this.dialog.search = false;

            this.movie = movie;
            if (genre) {
              this.genre = genre;
              this.getCollection();
            }
            this.dialog.view = true;
            window.scrollTo(0, 0);
            this.$forceUpdate();
          },
          async getCollection() {
            const movie = await fetch(
              `https://api.themoviedb.org/3/movie/${this.movie.id}?api_key=ab1391e8e1261f84f32827552b3e3935`
            ).then((response) => response.json());

            if (movie.belongs_to_collection) {
              this.collection = await fetch(
                `https://api.themoviedb.org/3/collection/${movie.belongs_to_collection.id}?api_key=ab1391e8e1261f84f32827552b3e3935`
              ).then((response) => response.json());
            } else {
              this.collection = {};
            }

            this.$forceUpdate();
          },
          async getGenres() {
            const response = await fetch(
              'https://api.themoviedb.org/3/genre/movie/list?api_key=ab1391e8e1261f84f32827552b3e3935'
            ).then((response) => response.json());

            response.genres.forEach((genre) => {
              genre.movies = [];
              this.genres[genre.id] = genre;
            });

            console.log(this.genres);
          },
          async getMovies() {
            this.list = await fetch(
              'https://api.themoviedb.org/4/list/7094731?api_key=ab1391e8e1261f84f32827552b3e3935'
            ).then((response) => response.json());

            this.movies.push(...this.list.results);
            this.list.results.forEach(async (movie) => {
              movie.genre_ids.forEach((genre) => {
                this.genres[genre].movies.push(movie);
              });
            });

            for (let index = 2; index < this.list.total_pages + 1; index++) {
              const list = await fetch(
                `https://api.themoviedb.org/4/list/7094731?api_key=ab1391e8e1261f84f32827552b3e3935&page=${index}`
              ).then((response) => response.json());

              this.movies.push(...list.results);

              list.results.forEach(async (movie) => {
                movie.genre_ids.forEach((genre) => {
                  this.genres[genre].movies.push(movie);
                });
              });
            }

            this.popularMovies = this.movies
              .sort((a, b) => b.popularity - a.popularity)
              .slice(0, 10);

            this.$forceUpdate();
          },
        },
      });
    </script>
  </body>
</html>
