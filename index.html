<!DOCTYPE html>
<html>
  <head>
    <link
      href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css"
      rel="stylesheet"
    />
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui"
    />
  </head>

  <style>
    .cursor-pointer {
      cursor: pointer;
    }

    .w-100 {
      width: 100%;
    }
  </style>

  <body>
    <div id="app">
      <v-app>
        <v-app-bar app color="primary" class="white--text font-weight-bold">
          <v-app-bar-nav-icon color="white"></v-app-bar-nav-icon>
          <v-spacer></v-spacer>

          <v-toolbar-title> Bollywood Silver Screen</v-toolbar-title>

          <v-spacer></v-spacer>
          <v-app-bar-nav-icon color="white" @click="openSearch()">
            <v-icon>mdi-magnify</v-icon>
          </v-app-bar-nav-icon>
        </v-app-bar>

        <v-main>
          <v-container v-if="mounted">
            <template v-for="(genre, index) in genres">
              <template v-if="genre.movies.length">
                <v-card-title class="text-subtitle-1 cursor-pointer" @click="openGenre(genre)">
                  {{genre.name}}
                  <v-spacer></v-spacer>
                  <v-icon>mdi-chevron-right</v-icon>
                </v-card-title>

                <v-slide-group>
                  <v-slide-item class="ml-2" v-for="(movie, index) in genre.movies" :key="index">
                    <v-card @click="onClick(movie, genre)" width="100">
                      <v-img :src="`https://image.tmdb.org/t/p/w500${movie.poster_path}`"></v-img>
                    </v-card>
                  </v-slide-item>
                </v-slide-group>
              </template>
            </template>

            <v-dialog v-model="dialog.search" fullscreen>
              <v-card>
                <v-toolbar color="primary">
                  <v-icon color="white" @click="dialog.search=false">mdi-arrow-left</v-icon>
                  <v-spacer></v-spacer>
                  <v-text-field
                    dense
                    solo
                    hide-details
                    class="w-100 mx-4"
                    v-model="search"
                    label="Search"
                  ></v-text-field>
                  <v-spacer></v-spacer>
                  <v-icon color="white" @click="openSearch()">mdi-magnify</v-icon>
                </v-toolbar>

                <v-list v-if="!search">
                  <v-subheader>Popular</v-subheader>
                  <v-list-item
                    @click="onClick(item, genre)"
                    v-for="(item, index) in popularMovies"
                    :key="index"
                  >
                    <v-list-item-avatar rounded>
                      <v-img :src="`https://image.tmdb.org/t/p/w500${item.poster_path}`"></v-img>
                    </v-list-item-avatar>
                    <v-list-item-content>
                      <v-list-item-title>{{item.title}}</v-list-item-title>
                    </v-list-item-content>
                  </v-list-item>
                </v-list>

                <v-list v-else>
                  <v-list-item
                    @click="onClick(item, genre)"
                    v-for="(item, index) in getFilteredMovies()"
                    :key="index"
                  >
                    <v-list-item-avatar rounded>
                      <v-img :src="`https://image.tmdb.org/t/p/w500${item.poster_path}`"></v-img>
                    </v-list-item-avatar>
                    <v-list-item-content>
                      <v-list-item-title>{{item.title}}</v-list-item-title>
                    </v-list-item-content>
                  </v-list-item>
                </v-list>
              </v-card>
            </v-dialog>

            <v-dialog v-model="dialog.collection" fullscreen>
              <v-card>
                <v-toolbar color="primary" class="mb-4">
                  <v-icon color="white" @click="dialog.collection=false">mdi-arrow-left</v-icon>
                  <v-spacer></v-spacer>
                  <v-toolbar-title class="white--text text-subtitle-1">
                    {{collection.name}}</v-toolbar-title
                  >
                  <v-spacer></v-spacer>
                  <v-icon color="white" @click="openSearch()">mdi-magnify</v-icon>
                </v-toolbar>

                <v-card-text>
                  <v-row>
                    <template v-for="(item, index) in collection.parts">
                      <v-col cols="4" md="2" :key="index">
                        <v-card :disabled="!hasComment(item)" @click="onClick(item, genre)">
                          <v-img
                            :src="`https://image.tmdb.org/t/p/w500${item.poster_path}`"
                          ></v-img>
                        </v-card>
                      </v-col>
                    </template>
                  </v-row>
                </v-card-text>
              </v-card>
            </v-dialog>

            <v-dialog v-model="dialog.genre" fullscreen>
              <v-card>
                <v-toolbar color="primary" class="mb-4">
                  <v-icon color="white" @click="dialog.genre=false">mdi-arrow-left</v-icon>
                  <v-spacer></v-spacer>
                  <v-toolbar-title class="white--text text-subtitle-1">
                    {{genre.name}}</v-toolbar-title
                  >
                  <v-spacer></v-spacer>
                  <v-icon color="white" @click="openSearch()">mdi-magnify</v-icon>
                </v-toolbar>

                <v-card-text>
                  <v-row>
                    <template v-for="(item, index) in genre.movies">
                      <v-col cols="4" md="2" :key="index">
                        <v-card @click="onClick(item, genre)">
                          <v-img
                            :src="`https://image.tmdb.org/t/p/w500${item.poster_path}`"
                          ></v-img>
                        </v-card>
                      </v-col>
                    </template>
                  </v-row>
                </v-card-text>
              </v-card>
            </v-dialog>

            <v-dialog v-model="dialog.view" fullscreen>
              <v-card>
                <v-toolbar color="primary">
                  <v-icon color="white" @click="dialog.view=false">mdi-arrow-left</v-icon>
                  <v-spacer></v-spacer>
                  <v-toolbar-title class="white--text text-subtitle-1">
                    {{movie.title}}</v-toolbar-title
                  >
                  <v-spacer></v-spacer>
                  <v-icon color="white" @click="openSearch()">mdi-magnify</v-icon>
                </v-toolbar>

                <v-responsive :aspect-ratio="getAspectRatio()" :key="getComment(movie)">
                  <iframe
                    width="100%"
                    height="100%"
                    :src="`https://www.youtube-nocookie.com/embed/${getComment(movie)}`"
                    title="YouTube video player"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen
                  ></iframe>
                </v-responsive>

                <v-card-title class="mb-4"> {{movie.title}} ({{getYear(movie)}}) </v-card-title>

                <v-card-subtitle>
                  <v-chip
                    dense
                    outlined
                    class="mr-2 mb-2"
                    v-for="(item, index) in getMovieGenres(movie)"
                    >{{item}}</v-chip
                  >
                </v-card-subtitle>

                <v-card-subtitle> {{movie.overview}} </v-card-subtitle>

                <!-- <v-card-actions>
                  <v-row>
                    <v-col cols="4" block><v-btn>Download</v-btn></v-col>
                    <v-col cols="4" block><v-btn>Watchist</v-btn></v-col>
                    <v-col cols="4" block><v-btn>Share</v-btn></v-col>
                  </v-row>
                </v-card-actions> -->

                <template v-if="collection.name">
                  <v-card-subtitle
                    class="cursor-pointer font-weight-bold"
                    @click="dialog.collection = true"
                  >
                    More from {{collection.name}}
                    <v-icon class="float-right">mdi-chevron-right</v-icon>
                  </v-card-subtitle>
                  <v-card-text>
                    <v-slide-group>
                      <template v-for="(item, index) in collection.parts">
                        <v-slide-item v-if="item.id != movie.id" class="ml-2" :key="index">
                          <v-card :disabled="!hasComment(item)" @click="onClick(item)" width="150">
                            <v-img
                              :src="`https://image.tmdb.org/t/p/w500${item.poster_path}`"
                            ></v-img>
                            <!-- <v-card-subtitle> {{item.title}} </v-card-subtitle> -->
                          </v-card>
                        </v-slide-item>
                      </template>
                    </v-slide-group>
                  </v-card-text>
                </template>

                <v-card-subtitle class="cursor-pointer font-weight-bold" @click="openGenre(genre)">
                  More Like This
                  <v-icon class="float-right">mdi-chevron-right</v-icon>
                </v-card-subtitle>
                <v-card-text>
                  <v-slide-group>
                    <template v-for="(item, index) in getGenreMovies()">
                      <v-slide-item v-if="item.id != movie.id" class="ml-2" :key="index">
                        <v-card @click="onClick(item, genre)" width="150">
                          <v-img
                            :src="`https://image.tmdb.org/t/p/w500${item.poster_path}`"
                          ></v-img>
                          <!-- <v-card-subtitle> {{item.title}} </v-card-subtitle> -->
                        </v-card>
                      </v-slide-item>
                    </template>
                  </v-slide-group>
                </v-card-text>
              </v-card>
            </v-dialog>
          </v-container>
        </v-main>

        <v-overlay :value="!mounted">
          <v-progress-circular indeterminate size="64"></v-progress-circular>
        </v-overlay>
      </v-app>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
    <script>
      new Vue({
        el: '#app',
        vuetify: new Vuetify({
          theme: {
            dark: true,
          },
        }),
        data() {
          return {
            dialog: {
              view: false,
              search: false,
              genre: false,
              collection: false,
            },
            search: '',
            movie: {},
            movies: [],
            popularMovies: [],
            genres: {},
            genre: {},
            comments: {},
            collection: {},
            mounted: false,
          };
        },
        async mounted() {
          await this.getGenres();
          await this.getMovies();
          this.mounted = true;
          console.log(this.$vuetify);
        },
        methods: {
          getAspectRatio() {
            if (this.$vuetify.breakpoint.lgAndUp) {
              return 10 / 4;
            } else {
              return 16 / 9;
            }
          },
          getYear(movie = {}) {
            return (movie.release_date || '').substring(0, 4);
          },
          getMovieGenres(movie) {
            return (movie.genre_ids || []).map((genre_id) => this.genres[genre_id].name);
          },
          openSearch() {
            this.dialog.genre = false;
            this.dialog.view = false;
            this.dialog.collection = false;
            this.dialog.search = true;
          },
          openGenre(genre) {
            this.genre = genre;
            this.dialog.genre = true;
            this.dialog.view = false;
            this.dialog.collection = false;
            this.dialog.search = false;
          },
          getFilteredMovies() {
            if (this.search) {
              return this.movies.filter((movie) => {
                return (movie.title || '')
                  .toLowerCase()
                  .includes((this.search || '').trim().toLowerCase());
              });
            } else {
              return [];
            }
          },
          getGenreMovies() {
            return (this.genre.movies || []).filter((movie) => {
              return !(this.collection.parts || []).some((part) => part.id == movie.id);
            });
          },
          hasComment(movie) {
            return !!this.comments[`movie:${movie.id}`];
          },
          getComment(movie) {
            return (this.comments[`movie:${movie.id}`] || '')
              .replace('https://www.youtube.com/watch?v=', '')
              .replace('https://youtu.be/', '');
          },
          onClick(movie, genre) {
            this.dialog.genre = false;
            this.dialog.search = false;
            this.dialog.collection = false;

            this.movie = movie;
            if (genre) {
              this.genre = genre;
              this.getCollection();
            }
            this.dialog.view = true;
            window.scrollTo(0, 0);
            this.$forceUpdate();
          },
          async getCollection() {
            const movie = await fetch(
              `https://api.themoviedb.org/3/movie/${this.movie.id}?api_key=ab1391e8e1261f84f32827552b3e3935`
              // { cache: 'force-cache' }
            ).then((response) => response.json());

            if (movie.belongs_to_collection) {
              this.collection = await fetch(
                `https://api.themoviedb.org/3/collection/${movie.belongs_to_collection.id}?api_key=ab1391e8e1261f84f32827552b3e3935`
                // { cache: 'force-cache' }
              ).then((response) => response.json());
            } else {
              this.collection = {};
            }

            this.$forceUpdate();
          },
          async getGenres() {
            const response = await fetch(
              'https://api.themoviedb.org/3/genre/movie/list?api_key=ab1391e8e1261f84f32827552b3e3935'
              // { cache: 'force-cache' }
            ).then((response) => response.json());

            response.genres.forEach((genre) => {
              genre.movies = [];
              this.genres[genre.id] = genre;
            });
          },
          async getMovies() {
            list = await fetch(
              'https://api.themoviedb.org/4/list/7094731?api_key=ab1391e8e1261f84f32827552b3e3935'
              // { cache: 'force-cache' }
            ).then((response) => response.json());

            Object.assign(this.comments, list.comments);

            this.movies.push(...list.results);

            list.results.forEach(async (movie) => {
              movie.genre_ids.forEach((genre) => {
                this.genres[genre].movies.push(movie);
              });
            });

            for (let index = 2; index < list.total_pages + 1; index++) {
              const list = await fetch(
                `https://api.themoviedb.org/4/list/7094731?api_key=ab1391e8e1261f84f32827552b3e3935&page=${index}`
                // { cache: 'force-cache' }
              ).then((response) => response.json());

              Object.assign(this.comments, list.comments);

              this.movies.push(...list.results);

              list.results.forEach(async (movie) => {
                movie.genre_ids.forEach((genre) => {
                  this.genres[genre].movies.push(movie);
                });
              });
            }

            for (const key in this.genres) {
              if (Object.hasOwnProperty.call(this.genres, key)) {
                const genre = this.genres[key];
                genre.movies = (genre.movies || []).sort((a, b) => b.popularity - a.popularity);
              }
            }

            this.popularMovies = this.movies
              .sort((a, b) => b.popularity - a.popularity)
              .slice(0, 10);

            this.$forceUpdate();
          },
        },
      });
    </script>
  </body>
</html>
